<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Ålesund Guide 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#2A5B87" />
    <meta name="description" content="Guía turística interactiva para Ålesund 2026" />
    
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjzH3iJzGSmgJQEB4bo2ISmRdwVfadfiyFHOkP_GvgwHjGZHrRsmt2WB0QvrsRQKl1AwJQ4fM-OwwKdTzxT2vhnIk-Xs-CPlwRy4k_3eLdzTB0nnrD7iBTbQQm68XmkwMQTbzXNp0ZyMTXJkT1huWoaL5QglUBxiVO4EIaYjZogI_nr6uIPx3lDmIZc_9g/s320/Gemini_Generated_Image_5y52ui5y52ui5y52.png" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              fjord: { 50:'#f0f9ff', 100:'#e0f2fe', 500:'#2A5B87', 600:'#0284c7', 900:'#0c4a6e' },
              mountain: { 500:'#3A7D44' },
              sunset: { 500:'#FFB347' }
            },
            fontFamily: { sans: ['Roboto Condensed', 'sans-serif'] },
            animation: {
                'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            }
          }
        }
      }
    </script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "recharts": "https://aistudiocdn.com/recharts@^3.5.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "leaflet": "https://aistudiocdn.com/leaflet@^1.9.4"
  }
}
</script>
    
    <!-- Leaflet JS Global -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { background-color: #f8fafc; overscroll-behavior-y: none; }
        .leaflet-container { width: 100%; height: 100%; z-index: 0; }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 4px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content { animation: fadeIn 0.2s ease-out forwards; }
        
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .active-card { animation: pulse-border 2s infinite; }
        
        .equalizer-bar {
            background-color: currentColor;
            animation: equalize 1s infinite;
        }
        .equalizer-bar:nth-child(2) { animation-delay: 0.2s; }
        .equalizer-bar:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes equalize {
            0% { height: 4px; }
            50% { height: 12px; }
            100% { height: 4px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { CalendarClock, Map as MapIcon, Wallet, BookOpen, Anchor, CheckCircle2, Circle, MapPin, AlertTriangle, Clock, ArrowRight, TrendingDown, Info, AlertCircle, ShoppingBag, Volume2, Camera, CloudSun, Wind, Droplets, Umbrella, X, Eye, Lightbulb, ChevronDown, Ticket, Zap, Calculator, ArrowRightLeft, RefreshCw, Languages, Utensils, Instagram, CloudRain, CloudSnow, Sun, Smartphone, Sunrise, Sunset, Moon, Play, Pause, Headphones, Plus, Trash2, Ship, Navigation } from 'lucide-react';

        // --- CONSTANTS ---
        const SHIP_DEPARTURE_TIME = "17:00";
        const ARRIVAL_TIME = "07:00";
        const ONBOARD_TIME = "16:30";
        const UPDATE_DATE = "10 de diciembre de 2025";
        
        // Coordinates from PDF Page 3
        const COORDS = {
            CRUISE_DOCK: { lat: 62.469187, lng: 6.156024 },
            KORSEGATA_BUS: { lat: 62.471565, lng: 6.155352 },
            BUS_STATION: { lat: 62.471507, lng: 6.155385 },
            ALNES_LIGHTHOUSE: { lat: 62.489265, lng: 5.965505 },
            ALNES_BUS_STOP: { lat: 62.487027, lng: 5.972907 },
            AKSLA_VIEWPOINT: { lat: 62.474297, lng: 6.164615 },
            ART_NOUVEAU_CENTER: { lat: 62.471047, lng: 6.151177 },
            ALESUND_CHURCH: { lat: 62.471255, lng: 6.146431 }
        };

        const INITIAL_ITINERARY = [
            {
                id: '1', title: 'Atraque MSC Euribia', startTime: '07:00', endTime: '07:00',
                locationName: 'Muelle de Cruceros', coords: COORDS.CRUISE_DOCK,
                description: 'El barco llega a puerto.',
                fullDescription: 'El barco llega a puerto. Prepárate para salir. Disfruta de la entrada al puerto con la vista de la ciudad Art Nouveau.',
                tips: 'Sincroniza tu reloj con la hora del barco antes de salir.',
                keyDetails: 'Hora de llegada.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false,
                instagramUrl: 'https://www.instagram.com/explore/tags/msceuribia/'
            },
            {
                id: '2', title: 'Desembarque', startTime: '07:15', endTime: '07:30',
                locationName: 'Muelle', coords: COORDS.CRUISE_DOCK,
                description: 'Baja del barco y dirígete a la salida.',
                fullDescription: 'Baja del barco y dirígete a la salida del muelle. El centro está muy cerca.',
                tips: 'Ten a mano la APP FRAM descargada para el bus.',
                keyDetails: 'Salida rápida.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false,
                instagramUrl: 'https://www.instagram.com/explore/tags/alesundhavn/'
            },
            {
                id: '3', title: 'Caminata a Parada Bus', startTime: '07:30', endTime: '07:50',
                locationName: 'Muelle', endLocationName: 'Parada Korsegata',
                coords: COORDS.CRUISE_DOCK, endCoords: COORDS.KORSEGATA_BUS,
                description: 'Camina hacia la parada Korsegata (10-15 min).',
                fullDescription: 'Camina hacia la parada de autobús Korsegata. Es un paseo breve desde el muelle hacia el centro.',
                tips: 'Usa el GPS de la app si tienes dudas.',
                keyDetails: '10-15 min a pie.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false,
                instagramUrl: 'https://www.instagram.com/explore/tags/korsegata/'
            },
            {
                id: '4', title: 'Bus hacia el Faro', startTime: '08:00', endTime: '09:00',
                locationName: 'Parada Korsegata', endLocationName: 'Isla de Godøya',
                coords: COORDS.KORSEGATA_BUS, endCoords: COORDS.ALNES_LIGHTHOUSE,
                description: 'Ruta escénica por túneles submarinos.',
                fullDescription: 'IDA. Toma el bus en Korsegata. Disfruta del paisaje atravesando los túneles submarinos hacia la isla de Godøya.',
                tips: 'Precio: 48 NOK por trayecto. Paga con App FRAM. Si pagas al conductor puede tener recargo o requerir efectivo.',
                keyDetails: 'Bus Público (FRAM).',
                priceNOK: 48, priceEUR: 4.20, type: 'transport', completed: false,
                ticketUrl: 'https://play.google.com/store/apps/details?id=no.frammr.fram&hl=es',
                routeUrl: `https://www.google.com/maps/dir/?api=1&origin=${COORDS.KORSEGATA_BUS.lat},${COORDS.KORSEGATA_BUS.lng}&destination=${COORDS.ALNES_BUS_STOP.lat},${COORDS.ALNES_BUS_STOP.lng}&travelmode=transit`,
                instagramUrl: 'https://www.instagram.com/explore/tags/godøya/'
            },
            {
                id: '5', title: 'Faro de Alnes (Alnes Fyr)', startTime: '09:10', endTime: '10:30',
                locationName: 'Faro de Alnes', coords: COORDS.ALNES_LIGHTHOUSE,
                description: 'Tiempo libre para visitar el faro y la costa.',
                fullDescription: 'Tiempo libre para visitar el faro, caminar por la costa y disfrutar del aire libre. Cafetería disponible si está abierta.',
                tips: 'El clima en el Faro puede ser ventoso. Lleva cortavientos.',
                keyDetails: 'Vistas al océano Atlántico.',
                priceNOK: 0, priceEUR: 0, type: 'sightseeing', completed: false,
                instagramUrl: 'https://www.instagram.com/explore/tags/alnesfyr/'
            },
            {
                id: '6', title: 'Bus de Regreso', startTime: '10:47', endTime: '11:47',
                locationName: 'Parada Alnes', endLocationName: 'Centro Ålesund',
                coords: COORDS.ALNES_BUS_STOP, endCoords: COORDS.KORSEGATA_BUS,
                description: 'VUELTA. ¡Sé puntual! El bus no espera.',
                fullDescription: 'Toma el bus en la parada Alnes para volver al centro.',
                tips: 'Llega a la parada de Alnes 10 minutos antes (10:37). Si pierdes el bus de las 10:47, el siguiente podría llegar demasiado tarde para el enlace con el City Train.',
                keyDetails: 'Bus Público (FRAM).',
                priceNOK: 48, priceEUR: 4.20, type: 'transport', completed: false, notes: 'CRITICAL',
                routeUrl: `https://www.google.com/maps/dir/?api=1&origin=${COORDS.ALNES_BUS_STOP.lat},${COORDS.ALNES_BUS_STOP.lng}&destination=${COORDS.KORSEGATA_BUS.lat},${COORDS.KORSEGATA_BUS.lng}&travelmode=transit`,
                instagramUrl: 'https://www.instagram.com/explore/tags/alesundnorway/'
            },
            {
                id: '7', title: 'Refrigerio Rápido', startTime: '12:00', endTime: '12:20',
                locationName: 'Centro Ålesund', coords: COORDS.KORSEGATA_BUS,
                description: 'Snack rápido o baño antes del tren.',
                fullDescription: 'Al llegar al centro, tienes unos minutos para un snack rápido o ir al baño antes del tren turístico.',
                tips: 'Algo ligero para aprovechar el tiempo.',
                keyDetails: 'Parada técnica.',
                priceNOK: 100, priceEUR: 9.00, type: 'food', completed: false,
                instagramUrl: 'https://www.instagram.com/explore/tags/alesundsentrum/'
            },
            {
                id: '8', title: 'City Train (Monte Aksla)', startTime: '12:30', endTime: '14:00',
                locationName: 'Parada Tren Turístico', endLocationName: 'Mirador Fjellstua',
                coords: COORDS.KORSEGATA_BUS, endCoords: COORDS.AKSLA_VIEWPOINT,
                description: 'Recorrido guiado y subida al mirador.',
                fullDescription: 'Sube al Tren Turístico. Recorrido guiado de 1h 10m que pasa por el centro y sube al Mirador Fjellstua (sin escaleras). La mejor vista de la ciudad.',
                tips: 'Este tren te ahorra subir los 418 escalones y te lleva directo al mirador.',
                keyDetails: 'Ticket: 330 NOK. Duración 70 min.',
                priceNOK: 330, priceEUR: 29.00, type: 'sightseeing', completed: false,
                ticketUrl: 'https://bytoget.no/',
                instagramUrl: 'https://www.instagram.com/explore/tags/aksla/'
            },
            {
                id: '9', title: 'Paseo Art Nouveau', startTime: '14:00', endTime: '15:30',
                locationName: 'Calle Apotekergata', coords: COORDS.ART_NOUVEAU_CENTER,
                description: 'Arquitectura única y canal Brosundet.',
                fullDescription: 'Camina relajadamente por la calle Apotekergata y el canal Brosundet. Tiempo para compras y fotos finales cerca del barco.',
                tips: 'No te pierdas el Centro Art Nouveau (Jugendstilsenteret) por fuera.',
                keyDetails: 'Paseo libre.',
                priceNOK: 0, priceEUR: 0, type: 'shopping', completed: false,
                instagramUrl: 'https://www.instagram.com/explore/tags/jugendstilsenteret/'
            },
            {
                id: '10', title: 'Regreso al Barco', startTime: '15:30', endTime: '16:00',
                locationName: 'Centro -> Muelle', coords: COORDS.CRUISE_DOCK,
                description: 'Camina hacia el muelle con margen.',
                fullDescription: 'Camina hacia el muelle de cruceros con margen de seguridad.',
                tips: 'Mejor sobrar tiempo que correr.',
                keyDetails: 'Caminata final.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false,
                instagramUrl: 'https://www.instagram.com/explore/tags/brosundet/'
            },
            {
                id: '11', title: '¡TODOS A BORDO!', startTime: '16:30', endTime: '16:30',
                locationName: 'MSC Euribia', coords: COORDS.CRUISE_DOCK,
                description: 'Hora límite estricta para embarcar.',
                fullDescription: 'Hora límite estricta para embarcar. La pasarela se retira.',
                tips: '¡No llegues tarde!',
                keyDetails: 'CRÍTICO.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false, notes: 'CRITICAL',
                instagramUrl: 'https://www.instagram.com/explore/tags/msccruises/'
            },
            {
                id: '12', title: 'ZARPA EL BARCO', startTime: '17:00', endTime: '17:00',
                locationName: 'Fiordo', coords: COORDS.CRUISE_DOCK,
                description: 'Disfruta la salida por el fiordo.',
                fullDescription: 'Disfruta la salida por el fiordo desde la cubierta.',
                tips: 'Vistas espectaculares de las islas.',
                keyDetails: 'Navegación.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false,
                instagramUrl: 'https://www.instagram.com/explore/tags/norwegianfjords/'
            }
        ];

        const PRONUNCIATIONS = [
            { word: 'Ålesund', phonetic: '/ˈɔːləsʉn/', simplified: 'O-le-sun', meaning: 'Estrecho de la anguila' },
            { word: 'Godøya', phonetic: '/god-øya/', simplified: 'GOD-eu-ia', meaning: 'Isla buena' },
            { word: 'Fjellstua', phonetic: '/fjell-stua/', simplified: 'FYEL-stua', meaning: 'Refugio de montaña' },
            { word: 'Aksla', phonetic: '/aksla/', simplified: 'AKS-la', meaning: 'El hombro (montaña)' },
            { word: 'Jugendstil', phonetic: '/yu-gen-stil/', simplified: 'YU-guen-stil', meaning: 'Art Nouveau' },
            { word: 'Skål', phonetic: '/skoːl/', simplified: 'SKOL', meaning: '¡Salud!' },
            { word: 'Takk', phonetic: '/tak/', simplified: 'TAK', meaning: 'Gracias' },
        ];

        const ALNES_AUDIO_GUIDE = [
            {
                id: 'alnes_1',
                title: '1. Introducción y El Viaje',
                text: "Bienvenidos, viajeros. Si miran hacia el horizonte, donde el mar parece no tener fin, están a punto de conocer uno de los símbolos más queridos de la costa oeste noruega: el Faro de Alnes.\n\nPara llegar aquí, hemos dejado atrás las calles de Ålesund y hemos viajado a través de túneles submarinos y puentes hasta llegar a la isla de Godøya. Fíjense en el paisaje que nos rodea. Ya no estamos protegidos por las tranquilas aguas del interior del fiordo; aquí, estamos a las puertas del Mar de Noruega."
            },
            {
                id: 'alnes_2',
                title: '2. Arquitectura y Resistencia',
                text: "Ante ustedes se alza una estructura inconfundible. A diferencia de muchos faros que son torres redondas de piedra o metal, el Faro de Alnes destaca por su arquitectura de madera y su peculiar forma cuadrada. Sus franjas rojas y blancas no son solo una elección estética; fueron diseñadas para ser vistas claramente por los pescadores entre la densa niebla y la espuma de las olas durante los duros inviernos nórdicos."
            },
            {
                id: 'alnes_3',
                title: '3. Historia (1852 - Hoy)',
                text: "La historia de este lugar se remonta a 1852. Imaginen por un momento la vida aquí hace casi dos siglos. Esta zona era vital para la pesca del arenque y el bacalao, pero también era traicionera. El faro original era modesto, apenas una lámpara de aceite, pero suficiente para guiar a los marineros de vuelta a casa sanos y salvos. La torre que ven hoy se construyó en 1876 y ha sido modernizada con el tiempo, pero su alma permanece intacta.\n\nHoy en día, el faro está totalmente automatizado, pero sigue cumpliendo una doble función: guía para los barcos y refugio cultural para nosotros, los visitantes."
            },
            {
                id: 'alnes_4',
                title: '4. La Experiencia y El Secreto',
                text: "Os invito a acercaros y, si se sienten con energía, a subir las empinadas escaleras de madera hasta la cima de la torre. La recompensa es una vista panorámica de 360 grados: por un lado, las majestuosas montañas de los Alpes de Sunnmøre; por el otro, la inmensidad del océano Atlántico. Es un lugar perfecto para sentir la fuerza de la naturaleza.\n\nY antes de irnos, un pequeño secreto local: no dejen de visitar la antigua casa del farero, justo al lado de la torre. Hoy funciona como una cafetería y galería de arte. Es casi una tradición obligatoria probar sus famosos pasteles caseros o las 'sveler' (una especie de tortita noruega) mientras se refugian del viento."
            },
            {
                id: 'alnes_5',
                title: '5. Despedida',
                text: "El Faro de Alnes no es solo una luz en la oscuridad; es un testimonio de la resistencia y la cultura costera de Noruega. Tómense su tiempo, respiren el aire salado y disfruten de este rincón del mundo donde el cielo se funde con el mar."
            }
        ];

        // --- UTILS ---
        const calculateDistance = (c1, c2) => {
            if(!c1 || !c2) return 0;
            const R = 6371e3; 
            const φ1 = c1.lat * Math.PI/180;
            const φ2 = c2.lat * Math.PI/180;
            const Δφ = (c2.lat-c1.lat) * Math.PI/180;
            const Δλ = (c2.lng-c1.lng) * Math.PI/180;
            const a = Math.sin(Δφ/2)*Math.sin(Δφ/2) + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        };

        const formatDistance = (meters) => {
            if (meters < 1000) return `${Math.round(meters)} m`;
            return `${(meters / 1000).toFixed(1)} km`;
        };

        const calculateDuration = (start, end) => {
            const [sh, sm] = start.split(':').map(Number);
            const [eh, em] = end.split(':').map(Number);
            let diff = (eh*60+em) - (sh*60+sm);
            if(diff < 0) diff += 24*60;
            const h = Math.floor(diff/60);
            const m = diff%60;
            return h > 0 && m > 0 ? `${h}h ${m}m` : (h > 0 ? `${h}h` : `${m} min`);
        };

        const calculateTimeGap = (endPrevious, startNext) => {
            const [eh, em] = endPrevious.split(':').map(Number);
            const [sh, sm] = startNext.split(':').map(Number);
            let diff = (sh*60+sm) - (eh*60+em);
            if (diff <= 0) return null;
            return diff < 60 ? `${diff} min` : `${Math.floor(diff/60)}h ${diff%60}m`;
        };

        const formatTimeRemaining = (targetTimeStr) => {
            const now = new Date();
            const [h, m] = targetTimeStr.split(':').map(Number);
            const target = new Date(now); target.setHours(h, m, 0, 0);
            if(target < now) return "Terminado";
            const diffMs = target - now;
            const dh = Math.floor(diffMs/(1000*60*60));
            const dm = Math.floor((diffMs%(1000*60*60))/(1000*60));
            return dh > 0 ? `${dh}h ${dm}m` : `${dm}m`;
        };

        // --- COMPONENTS ---

        const ActivityDetailModal = ({ activity, onClose, initialAutoOpen = false }) => {
            const [playingTrackId, setPlayingTrackId] = useState(null);
            const [showAudio, setShowAudio] = useState(initialAutoOpen);

            // Cleanup audio on close
            useEffect(() => {
                return () => {
                    window.speechSynthesis.cancel();
                };
            }, []);

            if (!activity) return null;

            const toggleTrack = (track) => {
                if (playingTrackId === track.id) {
                    window.speechSynthesis.cancel();
                    setPlayingTrackId(null);
                } else {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(track.text);
                    utterance.lang = 'es-ES';
                    utterance.rate = 1.0;
                    utterance.pitch = 1.0;
                    
                    utterance.onend = () => setPlayingTrackId(null);
                    utterance.onerror = () => setPlayingTrackId(null);
                    
                    window.speechSynthesis.speak(utterance);
                    setPlayingTrackId(track.id);
                }
            };
            
            // Determine which audio guide to use (if any)
            let audioData = null;
            let audioTitle = "";
            
            if (activity.id === '5') {
                audioData = ALNES_AUDIO_GUIDE;
                audioTitle = "Audioguía: El Guardián de Godøya";
            }
            
            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] modal-content">
                        {/* Header */}
                        <div className="bg-fjord-500 p-4 text-white relative flex-shrink-0">
                            <h3 className="text-xl font-bold pr-8">{activity.title}</h3>
                            <div className="flex items-center text-fjord-100 text-sm mt-1">
                                <Clock size={14} className="mr-1" />
                                {activity.startTime === activity.endTime ? activity.startTime : `${activity.startTime} - ${activity.endTime}`}
                            </div>
                            <button onClick={onClose} className="absolute top-4 right-4 text-white/80 hover:text-white bg-white/10 rounded-full p-1">
                                <X size={20} />
                            </button>
                        </div>
                        
                        {/* Content */}
                        <div className="p-5 overflow-y-auto">
                            {/* Audio Guide Toggle Section - Hidden if no data */}
                            {audioData && (
                                <div className="mb-6">
                                    {!showAudio ? (
                                        <button 
                                            onClick={() => setShowAudio(true)}
                                            className="w-full bg-gradient-to-r from-fjord-600 to-fjord-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center font-bold transition-transform active:scale-95 animate-pulse-slow"
                                        >
                                            <Headphones className="mr-2" size={24} />
                                            Abrir Audioguía y Textos
                                        </button>
                                    ) : (
                                        <div className="bg-slate-50 border border-slate-200 rounded-xl p-4 shadow-inner animate-in fade-in slide-in-from-top-2">
                                             <div className="flex justify-between items-center mb-4 pb-2 border-b border-slate-200">
                                                <h4 className="flex items-center text-fjord-600 font-bold">
                                                    <Headphones className="mr-2" size={20}/> {audioTitle}
                                                </h4>
                                                <button onClick={() => setShowAudio(false)} className="text-slate-400 hover:text-slate-600 bg-white p-1 rounded-full shadow-sm">
                                                    <X size={16} />
                                                </button>
                                             </div>
                                             <div className="space-y-4">
                                                {audioData.map((track) => {
                                                    const isPlaying = playingTrackId === track.id;
                                                    return (
                                                        <div key={track.id} className={`p-4 rounded-xl border transition-all ${isPlaying ? 'bg-white border-blue-400 shadow-md ring-1 ring-blue-100' : 'bg-white border-slate-100 shadow-sm'}`}>
                                                            <div className="flex justify-between items-start mb-3">
                                                                <h5 className={`text-sm font-bold leading-tight flex-1 pr-2 ${isPlaying ? 'text-blue-700' : 'text-slate-800'}`}>
                                                                    {track.title}
                                                                </h5>
                                                                <button 
                                                                    onClick={() => toggleTrack(track)}
                                                                    className={`p-2 rounded-full flex-shrink-0 transition-colors shadow-sm ${isPlaying ? 'bg-red-50 text-red-500' : 'bg-blue-50 text-blue-600 hover:bg-blue-100'}`}
                                                                >
                                                                    {isPlaying ? <Pause size={20} fill="currentColor" /> : <Play size={20} fill="currentColor" />}
                                                                </button>
                                                            </div>
                                                            
                                                            {/* Text Transcript */}
                                                            <div className="text-sm text-slate-600 leading-relaxed font-light text-justify whitespace-pre-wrap">
                                                                {track.text}
                                                            </div>

                                                            {isPlaying && (
                                                                <div className="mt-3 pt-2 border-t border-blue-50 flex items-center justify-center">
                                                                    <div className="flex space-x-1 h-3 items-end">
                                                                        <div className="equalizer-bar w-1 bg-blue-500"></div>
                                                                        <div className="equalizer-bar w-1 bg-blue-500"></div>
                                                                        <div className="equalizer-bar w-1 bg-blue-500"></div>
                                                                    </div>
                                                                    <span className="text-xs text-blue-500 ml-2 font-medium">Reproduciendo...</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                             </div>
                                             <div className="mt-4 text-center">
                                                <button onClick={() => setShowAudio(false)} className="text-xs text-slate-400 underline">Cerrar Audioguía</button>
                                             </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            <div className="mb-4">
                                <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Descripción</h4>
                                <p className="text-gray-700 leading-relaxed">{activity.fullDescription || activity.description}</p>
                            </div>
                            
                            <div className="mb-4 bg-orange-50 p-3 rounded-lg border border-orange-100">
                                <h4 className="text-xs font-bold text-orange-600 uppercase tracking-wider mb-1 flex items-center">
                                    <Lightbulb size={12} className="mr-1" /> Consejo Pro
                                </h4>
                                <p className="text-sm text-orange-800 italic whitespace-pre-wrap">{activity.tips}</p>
                            </div>
                            
                            {/* Instagram Button */}
                            {activity.instagramUrl && (
                                <a href={activity.instagramUrl} target="_blank" rel="noopener noreferrer" 
                                   className="flex items-center justify-center w-full mb-4 p-3 rounded-xl bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 text-white font-bold shadow-md hover:shadow-lg transition-all active:scale-95">
                                    <Instagram className="mr-2" size={20} />
                                    Ver Fotos en Instagram
                                </a>
                            )}
                            
                            {/* Actions */}
                            <div className="space-y-3 pt-2">
                                {activity.routeUrl && (
                                    <a href={activity.routeUrl} target="_blank" rel="noopener noreferrer" className="flex items-center justify-center w-full p-3 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 transition-colors">
                                        <Navigation className="mr-2" size={18} />
                                        Ver Ruta en Google Maps
                                    </a>
                                )}
                                {activity.ticketUrl && (
                                    <a href={activity.ticketUrl} target="_blank" rel="noopener noreferrer" className="flex items-center justify-center w-full p-3 bg-emerald-600 text-white rounded-xl font-bold shadow-md hover:bg-emerald-700 transition-colors">
                                        <Ticket className="mr-2" size={18} />
                                        {(activity.type === 'transport' && activity.title.includes('Bus')) ? 'Descargar App FRAM' : 'Ver Tickets / Info'}
                                    </a>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Timeline = ({ itinerary, onToggleComplete, onLocate, userLocation, onSelectActivity }) => {
            const now = new Date();
            const currentTimeMinutes = now.getHours() * 60 + now.getMinutes();
            
            return (
                <div className="pb-24 px-4 pt-4 max-w-lg mx-auto">
                    <h2 className="text-2xl font-bold text-fjord-500 mb-2">Ålesund Art Nouveau & Naturaleza</h2>
                    <p className="text-xs text-slate-500 mb-6 flex items-center">
                        <Info size={12} className="mr-1"/> Toca una tarjeta para ver detalles
                    </p>
                    
                    <div className="relative border-l-2 border-slate-200 ml-3">
                        {itinerary.map((act, index) => {
                            const [sh, sm] = act.startTime.split(':').map(Number);
                            const [eh, em] = act.endTime.split(':').map(Number);
                            const startMinutes = sh * 60 + sm;
                            const endMinutes = eh * 60 + em;
                            
                            // Check if single point in time (start == end)
                            const isPointInTime = startMinutes === endMinutes;
                            
                            // Status Checks
                            // If point in time, active for 1 minute or special handling
                            const isActive = isPointInTime 
                                ? (currentTimeMinutes >= startMinutes && currentTimeMinutes < startMinutes + 15) // Point active for 15 mins visually
                                : (currentTimeMinutes >= startMinutes && currentTimeMinutes < endMinutes);
                                
                            const isPast = currentTimeMinutes >= endMinutes;
                            const isCritical = act.notes === 'CRITICAL';
                            const isDeparture = act.title.includes('ZARPA');
                            const duration = calculateDuration(act.startTime, act.endTime);
                            const hasAudio = act.id === '5';
                            
                            // Calculate Gap to next activity
                            let gapElement = null;
                            if (index < itinerary.length - 1) {
                                const nextAct = itinerary[index + 1];
                                const gap = calculateTimeGap(act.endTime, nextAct.startTime);
                                if (gap) {
                                    // Check if NOW is in the gap
                                    const [nsh, nsm] = nextAct.startTime.split(':').map(Number);
                                    const nextStartMinutes = nsh * 60 + nsm;
                                    const isGapNow = currentTimeMinutes >= endMinutes && currentTimeMinutes < nextStartMinutes;

                                    gapElement = (
                                        <div className="relative pl-6 py-4">
                                            {isGapNow && (
                                                <div className="absolute left-[-6px] top-1/2 -translate-y-1/2 w-full flex items-center z-10">
                                                    <div className="w-3 h-3 bg-red-500 rounded-full border-2 border-white shadow"></div>
                                                    <div className="h-[2px] bg-red-500 w-full opacity-50"></div>
                                                    <span className="absolute right-0 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded font-bold">
                                                        AHORA {now.getHours()}:{String(now.getMinutes()).padStart(2,'0')}
                                                    </span>
                                                </div>
                                            )}
                                            <div className="flex items-center justify-center">
                                                <span className="bg-slate-100 text-slate-500 text-xs px-2 py-1 rounded-full border border-slate-200 flex items-center">
                                                    <ChevronDown size={12} className="mr-1" />
                                                    {gap} traslado / libre
                                                </span>
                                            </div>
                                        </div>
                                    );
                                }
                            }

                            // Calculate Progress if Active
                            let progress = 0;
                            if (isActive && !isPointInTime) {
                                const totalDuration = endMinutes - startMinutes;
                                const elapsed = currentTimeMinutes - startMinutes;
                                progress = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
                            }

                            return (
                                <React.Fragment key={act.id}>
                                    <div className="pl-6 relative group">
                                        {/* Dot */}
                                        <div 
                                            className={`absolute -left-[9px] top-4 w-5 h-5 rounded-full border-4 cursor-pointer transition-all bg-white z-10 ${
                                                act.completed ? 'border-emerald-500' : isActive ? 'border-blue-500 scale-125' : 'border-slate-300'
                                            }`}
                                            onClick={(e) => { e.stopPropagation(); onToggleComplete(act.id); }}
                                        >
                                            {act.completed && <div className="w-full h-full bg-emerald-500 rounded-full scale-50" />}
                                        </div>

                                        {/* Card */}
                                        <div 
                                            onClick={() => onSelectActivity(act)}
                                            className={`
                                                relative p-4 rounded-xl border shadow-sm transition-all cursor-pointer overflow-hidden
                                                ${isActive ? 'bg-white border-blue-400 ring-2 ring-blue-100 shadow-blue-100' : 'bg-white border-slate-200 hover:border-blue-300'}
                                                ${act.completed ? 'opacity-70 bg-slate-50' : ''}
                                                ${isCritical ? 'bg-red-50 border-red-200' : ''}
                                                ${isDeparture ? 'bg-slate-800 border-slate-700 text-white' : ''}
                                            `}
                                        >
                                            {isActive && !isPointInTime && (
                                                <div className="absolute top-0 left-0 w-full h-1 bg-blue-100">
                                                    <div className="h-full bg-blue-500 transition-all duration-1000" style={{ width: `${progress}%` }}></div>
                                                </div>
                                            )}

                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <div className="flex items-center space-x-2 mb-1">
                                                        <span className={`text-xs font-bold px-1.5 py-0.5 rounded ${
                                                            isDeparture ? 'bg-slate-700 text-slate-200' :
                                                            isActive ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600'
                                                        }`}>
                                                            {isPointInTime ? act.startTime : `${act.startTime} - ${act.endTime}`}
                                                        </span>
                                                        {!isPointInTime && <span className="text-xs text-slate-400 font-medium">{duration}</span>}
                                                        {isActive && <span className="text-[10px] font-bold text-blue-600 animate-pulse">⚡ EN CURSO</span>}
                                                    </div>
                                                    <h3 className={`font-bold text-lg leading-tight ${isCritical ? 'text-red-700' : isDeparture ? 'text-white' : 'text-slate-800'}`}>
                                                        {act.title}
                                                    </h3>
                                                </div>
                                                <div className="flex gap-2 pl-2 items-center">
                                                    {act.ticketUrl && <Ticket size={18} className="text-emerald-500" />}
                                                    {isCritical && <AlertTriangle size={20} className="text-red-500" />}
                                                    {isDeparture && <Ship size={20} className="text-blue-300" />}
                                                </div>
                                            </div>

                                            <p className={`text-sm line-clamp-2 mb-2 ${isDeparture ? 'text-slate-300' : 'text-slate-600'}`}>{act.description}</p>

                                            <div className={`flex items-center justify-between mt-2 pt-2 border-t ${isDeparture ? 'border-slate-700' : 'border-slate-100'}`}>
                                                <div className={`flex items-center text-xs ${isDeparture ? 'text-slate-400' : 'text-slate-500'}`}>
                                                    <MapPin size={12} className="mr-1" />
                                                    {act.locationName}
                                                </div>
                                                
                                                <div className="flex items-center space-x-2">
                                                    {hasAudio && (
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); onSelectActivity(act, true); }}
                                                            className="flex items-center text-xs font-bold text-white bg-purple-600 px-3 py-1.5 rounded-full shadow-sm hover:bg-purple-700 active:scale-95 transition-all"
                                                        >
                                                            <Headphones size={14} className="mr-1" />
                                                            Audioguía
                                                        </button>
                                                    )}
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); onLocate(act.coords, act.endCoords); }}
                                                        className="p-1.5 hover:bg-slate-100 rounded-full text-fjord-600"
                                                    >
                                                        <MapIcon size={16} className={isDeparture ? 'text-blue-300' : ''} />
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {gapElement}
                                </React.Fragment>
                            );
                        })}
                        
                        {/* Copyright Footer */}
                        <div className="text-center py-8 text-slate-400 text-xs mt-4">
                            <p className="font-medium">Ålesund Guide 2026</p>
                            <p>Actualizado el {UPDATE_DATE}</p>
                            <p className="mt-1">© 2025 - 2026 Gonzalo Arenas de la Hoz</p>
                        </div>
                    </div>
                </div>
            );
        };

        const Budget = ({ itinerary }) => {
            const [currency, setCurrency] = useState('NOK'); // Default NOK
            const [rate, setRate] = useState(11.4); // Approx rate NOK to EUR
            const [calcAmount, setCalcAmount] = useState('');
            const [calcMode, setCalcMode] = useState('NOK_TO_EUR'); // Default NOK to EUR
            
            // Toggle completed items for budget
            const [paidItems, setPaidItems] = useState([]); // Default UNCHECKED

            // Manual Expenses
            const [customExpenses, setCustomExpenses] = useState([]);
            const [newExpName, setNewExpName] = useState('');
            const [newExpCost, setNewExpCost] = useState('');
            const [isAddOpen, setIsAddOpen] = useState(false);

            // Fetch Live Rate
            useEffect(() => {
                fetch('https://api.exchangerate-api.com/v4/latest/EUR')
                    .then(res => res.json())
                    .then(data => {
                        if(data && data.rates && data.rates.NOK) {
                            setRate(data.rates.NOK);
                        }
                    })
                    .catch(err => console.log('Using offline rate'));
            }, []);

            const togglePaid = (id) => {
                if (paidItems.includes(id)) {
                    setPaidItems(paidItems.filter(i => i !== id));
                } else {
                    setPaidItems([...paidItems, id]);
                }
            };

            const addCustomExpense = () => {
                if(!newExpName || !newExpCost) return;
                const cost = parseFloat(newExpCost);
                if(isNaN(cost)) return;

                const newExp = {
                    id: 'cust_' + Date.now(),
                    title: newExpName,
                    priceNOK: currency === 'NOK' ? cost : cost * rate,
                    priceEUR: currency === 'EUR' ? cost : cost / rate,
                    type: 'extra'
                };
                
                setCustomExpenses([...customExpenses, newExp]);
                setNewExpName('');
                setNewExpCost('');
                setIsAddOpen(false);
            };
            
            const removeCustomExpense = (id) => {
                setCustomExpenses(customExpenses.filter(e => e.id !== id));
            };

            const stats = useMemo(() => {
                const totalEUR_Plan = itinerary.reduce((sum, item) => sum + item.priceEUR, 0);
                const totalEUR_Custom = customExpenses.reduce((sum, item) => sum + item.priceEUR, 0);
                
                // Spent = Checked Itinerary Items + All Custom Items (Assuming custom entries are paid)
                const spentEUR_Plan = itinerary
                    .filter(item => paidItems.includes(item.id))
                    .reduce((sum, item) => sum + item.priceEUR, 0);
                
                const totalEUR = totalEUR_Plan + totalEUR_Custom;
                const currentEUR = spentEUR_Plan + totalEUR_Custom;
                
                return {
                    total: currency === 'EUR' ? totalEUR : totalEUR * rate,
                    current: currency === 'EUR' ? currentEUR : currentEUR * rate,
                    pending: currency === 'EUR' ? (totalEUR - currentEUR) : (totalEUR - currentEUR) * rate
                };
            }, [itinerary, paidItems, currency, rate, customExpenses]);

            // Conversion logic
            const convertedValue = useMemo(() => {
                const val = parseFloat(calcAmount);
                if (isNaN(val)) return '---';
                if (calcMode === 'EUR_TO_NOK') return (val * rate).toFixed(2) + ' kr';
                return (val / rate).toFixed(2) + ' €';
            }, [calcAmount, calcMode, rate]);

            return (
                <div className="pb-24 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto">
                    {/* Header & Currency Toggle */}
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-fjord-500 flex items-center">
                            <Wallet className="mr-2" /> Gastos
                        </h2>
                        <div className="flex bg-slate-200 rounded-lg p-1">
                            <button onClick={() => setCurrency('EUR')} className={`px-3 py-1 text-sm rounded-md font-bold transition-all ${currency === 'EUR' ? 'bg-white shadow text-fjord-600' : 'text-slate-500'}`}>EUR</button>
                            <button onClick={() => setCurrency('NOK')} className={`px-3 py-1 text-sm rounded-md font-bold transition-all ${currency === 'NOK' ? 'bg-white shadow text-fjord-600' : 'text-slate-500'}`}>NOK</button>
                        </div>
                    </div>

                    {/* Converter Tool */}
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="text-xs font-bold text-slate-400 uppercase flex items-center">
                                <Calculator size={12} className="mr-1"/> Conversor (1€ ≈ {rate.toFixed(2)} kr)
                            </h3>
                            <button onClick={() => setCalcMode(prev => prev === 'EUR_TO_NOK' ? 'NOK_TO_EUR' : 'EUR_TO_NOK')} className="p-1 bg-slate-100 rounded hover:bg-slate-200">
                                <ArrowRightLeft size={14} className="text-slate-600" />
                            </button>
                        </div>
                        <div className="flex items-center space-x-2">
                            <div className="relative flex-1">
                                <input 
                                    type="number" 
                                    value={calcAmount}
                                    onChange={(e) => setCalcAmount(e.target.value)}
                                    placeholder="Cantidad"
                                    className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg font-mono text-lg outline-none focus:border-fjord-500"
                                />
                                <span className="absolute right-3 top-1/2 -translate-y-1/2 text-sm text-slate-400 font-bold">
                                    {calcMode === 'EUR_TO_NOK' ? '€' : 'kr'}
                                </span>
                            </div>
                            <div className="text-slate-400"><ArrowRight size={16}/></div>
                            <div className="flex-1 p-2 bg-fjord-50 border border-fjord-100 rounded-lg text-lg font-bold text-fjord-700 text-center">
                                {convertedValue}
                            </div>
                        </div>
                    </div>

                    {/* Big Stats Card */}
                    <div className="bg-gradient-to-r from-fjord-600 to-fjord-800 rounded-2xl p-6 text-white shadow-xl mb-6 relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-10"><Wallet size={100}/></div>
                        <div className="relative z-10">
                            <p className="text-fjord-200 text-xs font-bold uppercase tracking-wider mb-1">Gasto Realizado</p>
                            <div className="text-4xl font-bold mb-2">
                                {currency === 'EUR' ? '€' : ''}{stats.current.toFixed(0)}{currency === 'NOK' ? ' kr' : ''}
                            </div>
                            <div className="w-full bg-black/20 h-2 rounded-full mb-2">
                                <div className="bg-emerald-400 h-full rounded-full transition-all duration-500" style={{ width: `${Math.min(100, (stats.current / stats.total) * 100)}%` }}></div>
                            </div>
                            <div className="flex justify-between text-xs text-fjord-100 font-medium">
                                <span>Total + Extras: {stats.total.toFixed(0)}</span>
                                <span>Pendiente: {stats.pending.toFixed(0)}</span>
                            </div>
                        </div>
                    </div>

                    {/* Savings Tip */}
                     <div className="bg-emerald-50 border border-emerald-100 rounded-lg p-4 flex items-start mb-6">
                        <TrendingDown className="text-emerald-600 mt-1 mr-3 flex-shrink-0" size={20} />
                        <div>
                        <h4 className="font-bold text-emerald-800 text-sm">Consejo de Ahorro</h4>
                        <p className="text-xs text-emerald-700 mt-1">
                            Si omites el City Train y subes andando al mirador Aksla (418 escalones), ahorras <span className="font-bold">{currency === 'EUR' ? '€29' : '330 kr'}</span> por persona.
                        </p>
                        </div>
                    </div>

                    {/* Manual Expense Input */}
                    {!isAddOpen ? (
                        <button 
                            onClick={() => setIsAddOpen(true)}
                            className="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-500 font-bold mb-6 flex items-center justify-center hover:bg-slate-50 hover:border-slate-400 transition-colors"
                        >
                            <Plus size={20} className="mr-2"/> Añadir Gasto Extra
                        </button>
                    ) : (
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6 animate-in fade-in slide-in-from-top-2">
                             <div className="flex justify-between items-center mb-2">
                                <h4 className="font-bold text-sm text-slate-700">Nuevo Gasto</h4>
                                <button onClick={() => setIsAddOpen(false)}><X size={18} className="text-slate-400"/></button>
                             </div>
                             <div className="space-y-3">
                                <input 
                                    type="text" placeholder="Concepto (ej: Imán)" 
                                    className="w-full p-2 rounded border border-slate-300 text-sm"
                                    value={newExpName} onChange={e => setNewExpName(e.target.value)}
                                />
                                <div className="flex space-x-2">
                                    <input 
                                        type="number" placeholder="Precio" 
                                        className="flex-1 p-2 rounded border border-slate-300 text-sm"
                                        value={newExpCost} onChange={e => setNewExpCost(e.target.value)}
                                    />
                                    <div className="flex items-center bg-white px-3 border border-slate-300 rounded text-sm font-bold text-slate-500">
                                        {currency}
                                    </div>
                                </div>
                                <button 
                                    onClick={addCustomExpense}
                                    className="w-full bg-fjord-600 text-white py-2 rounded-lg font-bold text-sm shadow hover:bg-fjord-700"
                                >
                                    Guardar
                                </button>
                             </div>
                        </div>
                    )}

                    {/* Interactive List */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                        {/* Custom Expenses List */}
                        {customExpenses.map((item) => (
                             <div 
                                key={item.id} 
                                className="flex items-center justify-between p-4 border-b border-slate-50 bg-yellow-50/50"
                            >
                                <div className="flex items-center">
                                    <div className="w-5 h-5 rounded border border-emerald-500 bg-emerald-500 mr-3 flex items-center justify-center">
                                        <CheckCircle2 size={14} className="text-white" />
                                    </div>
                                    <div>
                                        <p className="font-medium text-slate-800">{item.title}</p>
                                        <p className="text-xs text-slate-400 italic">Extra Manual</p>
                                    </div>
                                </div>
                                <div className="flex items-center">
                                    <div className="font-bold font-mono text-fjord-600 mr-3">
                                        {currency === 'EUR' ? `€${item.priceEUR.toFixed(0)}` : `${item.priceNOK.toFixed(0)} kr`}
                                    </div>
                                    <button onClick={() => removeCustomExpense(item.id)} className="text-red-400 hover:text-red-600">
                                        <Trash2 size={16}/>
                                    </button>
                                </div>
                            </div>
                        ))}

                        {/* Planned Itinerary List */}
                        {itinerary.filter(i => i.priceEUR > 0).map((item) => (
                            <div 
                                key={item.id} 
                                onClick={() => togglePaid(item.id)}
                                className="flex items-center justify-between p-4 border-b border-slate-50 last:border-0 hover:bg-slate-50 cursor-pointer transition-colors"
                            >
                                <div className="flex items-center">
                                    <div className={`w-5 h-5 rounded border mr-3 flex items-center justify-center transition-colors ${paidItems.includes(item.id) ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300 bg-white'}`}>
                                        {paidItems.includes(item.id) && <CheckCircle2 size={14} className="text-white" />}
                                    </div>
                                    <div>
                                        <p className={`font-medium ${paidItems.includes(item.id) ? 'text-slate-400 line-through' : 'text-slate-800'}`}>{item.title}</p>
                                        <p className="text-xs text-slate-400 capitalize">{item.type}</p>
                                    </div>
                                </div>
                                <div className={`font-bold font-mono ${paidItems.includes(item.id) ? 'text-slate-400' : 'text-fjord-600'}`}>
                                    {currency === 'EUR' ? `€${item.priceEUR}` : `${item.priceNOK} kr`}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Guide = ({ userLocation }) => {
            const [playing, setPlaying] = useState(null);
            const [weather, setWeather] = useState(null);
            const [forecast, setForecast] = useState([]);
            const [hourlyForecast, setHourlyForecast] = useState([]);
            const [astronomy, setAstronomy] = useState(null);
            const [showCamera, setShowCamera] = useState(false);

            // Fetch Weather & Solar Data
            useEffect(() => {
                // Weather for Alesund (Lat 62.47, Lng 6.15)
                fetch('https://api.open-meteo.com/v1/forecast?latitude=62.47&longitude=6.15&current=temperature_2m,weather_code,is_day&hourly=temperature_2m,precipitation_probability,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Europe%2FBerlin&forecast_days=5')
                    .then(res => res.json())
                    .then(data => {
                        setWeather(data);
                        
                        // Process Hourly (07:00 - 18:00 for today)
                        if (data.hourly) {
                            const hourly = [];
                            // Loop through first 24 indices (Today)
                            for(let i = 0; i < 24; i++) {
                                const timeStr = data.hourly.time[i]; // "2025-12-04T07:00"
                                const hourStr = timeStr.split('T')[1].split(':')[0];
                                const hour = parseInt(hourStr, 10);
                                
                                if (hour >= 7 && hour <= 18) {
                                    hourly.push({
                                        time: `${hourStr}:00`,
                                        temp: Math.round(data.hourly.temperature_2m[i]),
                                        precip: data.hourly.precipitation_probability[i],
                                        code: data.hourly.weather_code[i]
                                    });
                                }
                            }
                            setHourlyForecast(hourly);
                        }

                        // Process 5-day forecast
                        if(data.daily) {
                            const days = data.daily.time.map((t, i) => ({
                                date: t,
                                max: data.daily.temperature_2m_max[i],
                                min: data.daily.temperature_2m_min[i],
                                code: data.daily.weather_code[i]
                            }));
                            setForecast(days);
                        }
                    })
                    .catch(e => console.log('Weather offline'));

                // Solar/Astronomy (Using sunrise-sunset.org or similar, or Open-Meteo daily)
                fetch('https://api.open-meteo.com/v1/forecast?latitude=62.47&longitude=6.15&daily=sunrise,sunset,daylight_duration&timezone=Europe%2FBerlin&forecast_days=1')
                    .then(res => res.json())
                    .then(data => {
                        if (data.daily) {
                            setAstronomy({
                                sunrise: data.daily.sunrise[0], // ISO String
                                sunset: data.daily.sunset[0],   // ISO String
                                duration: (data.daily.daylight_duration[0] / 3600).toFixed(1)
                            });
                        }
                    })
                    .catch(e => console.log("Astronomy offline"));
            }, []);

            const playAudio = (text) => {
                if ('speechSynthesis' in window) {
                    setPlaying(text);
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'no-NO'; // Norwegian
                    utterance.rate = 0.9;
                    utterance.onend = () => setPlaying(null);
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert("Tu navegador no soporta audio.");
                }
            };

            const getWeatherIcon = (code) => {
                if (code <= 3) return <Sun className="text-yellow-500" />;
                if (code <= 60) return <CloudRain className="text-blue-400" />;
                return <CloudSnow className="text-gray-400" />;
            };

            const handleSOS = () => {
                if (!userLocation) {
                    alert("Necesitamos tu ubicación primero. Asegúrate de tener el GPS activo.");
                    return;
                }
                const text = `🆘 SOS! Necesito ayuda. Mi ubicación actual en Ålesund es: https://maps.google.com/?q=${userLocation.lat},${userLocation.lng}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            };

            const openTranslator = () => {
                // Google Translate Camera Mode
                window.open('https://translate.google.com/?sl=no&tl=es&op=images', '_blank');
            };
            
            const openMSCApp = () => {
                // Try to open Play Store page which will offer "Open" if installed
                window.open('https://play.google.com/store/apps/details?id=com.msccruises.mscforme', '_blank');
            };

            // Solar Chart Helper
            const renderSolarChart = () => {
                if (!astronomy) return <div className="text-xs text-slate-400">Cargando datos solares...</div>;

                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                const totalMinutes = 24 * 60;
                const nowPercent = (currentMinutes / totalMinutes) * 100;

                const sunriseDate = new Date(astronomy.sunrise);
                const sunsetDate = new Date(astronomy.sunset);
                
                const sunriseMins = sunriseDate.getHours() * 60 + sunriseDate.getMinutes();
                const sunsetMins = sunsetDate.getHours() * 60 + sunsetDate.getMinutes();
                
                const sunrisePercent = (sunriseMins / totalMinutes) * 100;
                const sunsetPercent = (sunsetMins / totalMinutes) * 100;

                const sunriseStr = `${String(sunriseDate.getHours()).padStart(2,'0')}:${String(sunriseDate.getMinutes()).padStart(2,'0')}`;
                const sunsetStr = `${String(sunsetDate.getHours()).padStart(2,'0')}:${String(sunsetDate.getMinutes()).padStart(2,'0')}`;

                return (
                    <div className="mt-4 bg-slate-900 rounded-xl p-4 text-white relative overflow-hidden shadow-inner">
                        <div className="flex justify-between text-xs text-slate-400 mb-6 font-mono">
                            <span>00:00</span>
                            <span>12:00</span>
                            <span>23:59</span>
                        </div>
                        
                        {/* The Bar Container */}
                        <div className="relative h-12 w-full rounded-full bg-slate-800 overflow-hidden border border-slate-700">
                            {/* Day Segment (Blue) */}
                            <div 
                                className="absolute top-0 bottom-0 bg-sky-400"
                                style={{ 
                                    left: `${sunrisePercent}%`, 
                                    width: `${sunsetPercent - sunrisePercent}%` 
                                }}
                            ></div>

                            {/* Sunrise Gradient Overlay */}
                            <div 
                                className="absolute top-0 bottom-0 w-8 -ml-4 bg-gradient-to-r from-slate-800 via-orange-400 to-sky-400 opacity-90"
                                style={{ left: `${sunrisePercent}%` }}
                            ></div>

                            {/* Sunset Gradient Overlay */}
                            <div 
                                className="absolute top-0 bottom-0 w-8 -ml-4 bg-gradient-to-r from-sky-400 via-orange-500 to-slate-800 opacity-90"
                                style={{ left: `${sunsetPercent}%` }}
                            ></div>
                            
                            {/* NOW Indicator */}
                            <div 
                                className="absolute top-0 bottom-0 w-0.5 bg-red-500 z-10 shadow-[0_0_10px_rgba(239,68,68,0.8)]"
                                style={{ left: `${nowPercent}%` }}
                            >
                                <div className="absolute -top-1 -left-[3px] w-2 h-2 bg-red-500 rounded-full"></div>
                                <div className="absolute top-1/2 -left-6 bg-red-600 text-white text-[9px] font-bold px-1 rounded transform -translate-y-1/2">AHORA</div>
                            </div>
                        </div>

                        {/* Labels positioned absolutely */}
                        <div className="relative h-6 mt-1 w-full text-[10px] font-bold">
                            <div 
                                className="absolute transform -translate-x-1/2 flex flex-col items-center text-yellow-400"
                                style={{ left: `${sunrisePercent}%` }}
                            >
                                <ArrowRight size={10} className="-rotate-90 mb-0.5"/>
                                <span>{sunriseStr}</span>
                            </div>
                            <div 
                                className="absolute transform -translate-x-1/2 flex flex-col items-center text-orange-400"
                                style={{ left: `${sunsetPercent}%` }}
                            >
                                <ArrowRight size={10} className="-rotate-90 mb-0.5"/>
                                <span>{sunsetStr}</span>
                            </div>
                        </div>
                        
                        <div className="mt-4 flex items-center justify-between text-xs text-slate-300 bg-white/5 p-2 rounded">
                            <div className="flex items-center"><Sunrise size={14} className="text-yellow-400 mr-2"/> Amanecer</div>
                            <div className="font-mono">{astronomy.duration}h Luz</div>
                            <div className="flex items-center">Atardecer <Sunset size={14} className="text-orange-500 ml-2"/></div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="pb-24 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto">
                    
                    {/* SOS & Apps Buttons */}
                    <div className="grid grid-cols-2 gap-3 mb-6">
                        <button 
                            onClick={handleSOS}
                            className="bg-red-600 text-white p-4 rounded-xl shadow-lg flex flex-col items-center justify-center active:scale-95 transition-transform animate-pulse-slow"
                        >
                            <AlertTriangle size={32} className="mb-2" />
                            <span className="font-bold text-sm">SOS EMERGENCIA</span>
                            <span className="text-[10px] opacity-80 mt-1">Enviar Ubicación</span>
                        </button>
                        
                        <div className="flex flex-col gap-2">
                             <button 
                                onClick={openMSCApp}
                                className="flex-1 bg-blue-900 text-white p-2 rounded-xl shadow flex items-center justify-center active:scale-95"
                            >
                                <Anchor size={20} className="mr-2" />
                                <span className="text-xs font-bold">App MSC</span>
                            </button>
                            <button 
                                onClick={openTranslator}
                                className="flex-1 bg-indigo-600 text-white p-2 rounded-xl shadow flex items-center justify-center active:scale-95"
                            >
                                <Camera size={20} className="mr-2" />
                                <span className="text-xs font-bold">Traductor Visual</span>
                            </button>
                        </div>
                    </div>

                    <h2 className="text-2xl font-bold text-fjord-500 mb-4">Guía Local</h2>

                    {/* Solar Chart */}
                    <div className="mb-8">
                        <h3 className="font-bold text-slate-700 mb-2 flex items-center"><Sun size={18} className="mr-2 text-orange-500"/> Ciclo Solar Hoy</h3>
                        {renderSolarChart()}
                    </div>

                    {/* Hourly Weather Forecast (07:00 - 18:00) */}
                    {hourlyForecast.length > 0 && (
                        <div className="mb-8">
                             <h3 className="font-bold text-slate-700 mb-4 flex items-center"><Clock size={18} className="mr-2 text-blue-500"/> Clima por Horas (07:00 - 18:00)</h3>
                             <div className="flex overflow-x-auto pb-4 space-x-3 snap-x">
                                {hourlyForecast.map((hour, idx) => (
                                    <div key={idx} className="flex-none w-20 bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex flex-col items-center justify-center snap-center">
                                        <span className="text-xs font-bold text-slate-400 mb-2">{hour.time}</span>
                                        <div className="mb-2 scale-125">{getWeatherIcon(hour.code)}</div>
                                        <span className="text-lg font-bold text-slate-800">{hour.temp}°</span>
                                        <div className="flex items-center text-[10px] text-blue-500 font-medium mt-1">
                                            <Droplets size={8} className="mr-1"/> {hour.precip}%
                                        </div>
                                    </div>
                                ))}
                             </div>
                        </div>
                    )}

                    {/* 5-Day Forecast */}
                    <div className="mb-8">
                         <h3 className="font-bold text-slate-700 mb-4 flex items-center"><CloudSun size={18} className="mr-2 text-blue-500"/> Pronóstico 5 Días</h3>
                         <div className="bg-white rounded-xl shadow-sm border border-slate-200 divide-y divide-slate-100">
                            {forecast.length > 0 ? forecast.map((day, i) => {
                                const date = new Date(day.date);
                                const dayName = date.toLocaleDateString('es-ES', { weekday: 'long' });
                                return (
                                    <div key={day.date} className="p-3 flex justify-between items-center">
                                        <span className="capitalize w-24 font-medium text-slate-700">{i===0 ? 'Hoy' : dayName}</span>
                                        <div className="flex items-center">
                                            {getWeatherIcon(day.code)}
                                            <span className="ml-2 text-sm text-slate-500">{day.code <= 3 ? 'Soleado' : 'Nublado'}</span>
                                        </div>
                                        <div className="text-sm font-mono font-bold text-slate-800">
                                            {Math.round(day.max)}° <span className="text-slate-400">/ {Math.round(day.min)}°</span>
                                        </div>
                                    </div>
                                )
                            }) : <div className="p-4 text-center text-slate-400">Cargando clima...</div>}
                         </div>
                    </div>
                    
                    {/* Pronunciation */}
                    <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><Volume2 size={18} className="mr-2"/> Diccionario Exprés</h3>
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                        {PRONUNCIATIONS.map((item, idx) => (
                        <div key={item.word} className={`p-4 flex justify-between items-center ${idx !== PRONUNCIATIONS.length - 1 ? 'border-b border-slate-50' : ''}`}>
                            <div>
                                <div className="flex items-baseline space-x-2">
                                    <span className="font-bold text-lg text-fjord-700">{item.word}</span>
                                    <span className="text-xs text-slate-400 font-mono bg-slate-100 px-1 rounded">{item.simplified}</span>
                                </div>
                                <p className="text-xs text-slate-500 mt-1 italic">{item.meaning}</p>
                            </div>
                            <button 
                                onClick={() => playAudio(item.word)}
                                className={`p-3 rounded-full transition-colors ${playing === item.word ? 'bg-emerald-100 text-emerald-600 scale-110' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}`}
                            >
                            <Volume2 size={20} />
                            </button>
                        </div>
                        ))}
                    </div>

                     {/* Footer */}
                     <div className="text-center py-8 text-slate-400 text-xs">
                        <p className="font-medium">Ålesund Guide 2026</p>
                        <p>Actualizado el {UPDATE_DATE}</p>
                        <p className="mt-1">© 2025 - 2026 Gonzalo Arenas de la Hoz</p>
                    </div>
                </div>
            );
        };

        const MapComponent = ({ activities, userLocation, focusedLocation }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const layersRef = useRef([]);

            useEffect(() => {
                if (!mapContainerRef.current || mapInstanceRef.current) return;
                // Center map on Ålesund
                const map = L.map(mapContainerRef.current).setView([62.4722, 6.1497], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
                mapInstanceRef.current = map;
                return () => { map.remove(); mapInstanceRef.current = null; };
            }, []);

            useEffect(() => {
                const map = mapInstanceRef.current;
                if (!map) return;
                
                layersRef.current.forEach(l => l.remove());
                layersRef.current = [];

                // Custom Icons
                const createIcon = (color) => L.divIcon({
                    className: 'custom-pin',
                    html: `<div style="background-color: ${color}; width: 24px; height: 24px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid white; box-shadow: 2px 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;"><div style="width: 8px; height: 8px; background: white; border-radius: 50%; transform: rotate(45deg);"></div></div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 24],
                    popupAnchor: [0, -24]
                });

                activities.forEach(act => {
                    const marker = L.marker([act.coords.lat, act.coords.lng], { icon: createIcon('#2A5B87') })
                        .addTo(map).bindPopup(`<b>${act.title}</b><br/>${act.locationName}`);
                    layersRef.current.push(marker);

                    if (act.endCoords) {
                         const endMarker = L.marker([act.endCoords.lat, act.endCoords.lng], { icon: createIcon('#3A7D44') })
                            .addTo(map).bindPopup(`<b>Fin: ${act.title}</b>`);
                        layersRef.current.push(endMarker);
                        const polyline = L.polyline([[act.coords.lat, act.coords.lng], [act.endCoords.lat, act.endCoords.lng]], { color: '#2A5B87', weight: 4, opacity: 0.6, dashArray: '10, 10' }).addTo(map);
                        layersRef.current.push(polyline);
                    }
                });

                if (userLocation) {
                    const userMarker = L.circleMarker([userLocation.lat, userLocation.lng], { radius: 8, fillColor: '#3b82f6', color: '#fff', weight: 3, fillOpacity: 1 }).addTo(map);
                    layersRef.current.push(userMarker);
                }
            }, [activities, userLocation]);

            useEffect(() => {
                if(mapInstanceRef.current && focusedLocation) {
                    mapInstanceRef.current.setView([focusedLocation.lat, focusedLocation.lng], 18, { animate: true, duration: 1.5 });
                }
            }, [focusedLocation]);

            return <div ref={mapContainerRef} className="w-full h-full bg-slate-100" />;
        };

        const App = () => {
            const [itinerary, setItinerary] = useState(INITIAL_ITINERARY);
            const [activeTab, setActiveTab] = useState('timeline');
            const [userLocation, setUserLocation] = useState(null);
            const [mapFocus, setMapFocus] = useState(null);
            
            // State for selected activity detail, can include config like { activity, autoOpenAudio: true }
            const [selectedActivityConfig, setSelectedActivityConfig] = useState(null);
            
            const [countdown, setCountdown] = useState('');
            const [countdownLabel, setCountdownLabel] = useState('Salida');

            useEffect(() => {
                if ('geolocation' in navigator) {
                    const id = navigator.geolocation.watchPosition(
                        p => setUserLocation({ lat: p.coords.latitude, lng: p.coords.longitude }),
                        e => console.warn(e),
                        { enableHighAccuracy: true }
                    );
                    return () => navigator.geolocation.clearWatch(id);
                }
            }, []);

            // Smart Countdown
            useEffect(() => {
                const interval = setInterval(() => {
                    const now = new Date();
                    
                    // Parse Times
                    const [ah, am] = ARRIVAL_TIME.split(':').map(Number);
                    const arrivalDate = new Date(); arrivalDate.setHours(ah, am, 0, 0);

                    const [oh, om] = ONBOARD_TIME.split(':').map(Number);
                    const onboardDate = new Date(); onboardDate.setHours(oh, om, 0, 0);

                    let target, label;

                    if (now < arrivalDate) {
                        target = arrivalDate;
                        label = "Faltan para Llegada";
                    } else {
                        target = onboardDate;
                        label = "Tiempo Restante";
                    }

                    setCountdownLabel(label);

                    const diff = target - now;
                    
                    if (diff <= 0 && target === onboardDate) setCountdown("¡A BORDO!");
                    else if (diff <= 0 && target === arrivalDate) setCountdown("¡LLEGANDO!");
                    else {
                        const hr = Math.floor(diff/(1000*60*60));
                        const mn = Math.floor((diff%(1000*60*60))/(1000*60));
                        const sc = Math.floor((diff%(1000*60))/1000);
                        setCountdown(`${hr}h ${mn}m ${sc}s`);
                    }
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            const handleToggleComplete = (id) => {
                setItinerary(prev => prev.map(a => a.id === id ? { ...a, completed: !a.completed } : a));
            };

            const handleLocate = (c1, c2) => {
                setMapFocus(c1);
                setActiveTab('map');
            };
            
            const handleSelectActivity = (activity, autoOpenAudio = false) => {
                setSelectedActivityConfig({ activity, autoOpenAudio });
            };

            return (
                <div className="flex flex-col h-screen bg-slate-50 text-slate-900 font-sans overflow-hidden select-none">
                    <header className="bg-fjord-900 text-white p-3 shadow-md z-20 flex justify-between items-center shrink-0">
                        <div className="flex items-center">
                            <Anchor className="mr-2 text-sunset-500" size={20} />
                            <div>
                                <h1 className="font-bold text-sm leading-none">Todos a Bordo: {ONBOARD_TIME}</h1>
                                <p className="text-[10px] text-fjord-200">Salida Barco: {SHIP_DEPARTURE_TIME}</p>
                            </div>
                        </div>
                        <div className="text-right">
                             <div className="text-[10px] text-sunset-200 uppercase tracking-widest">{countdownLabel}</div>
                             <div className="text-xl font-mono font-bold text-sunset-500 tabular-nums">{countdown}</div>
                        </div>
                    </header>

                    <main className="flex-1 overflow-hidden relative">
                        {activeTab === 'timeline' && <div className="h-full overflow-y-auto"><Timeline itinerary={itinerary} onToggleComplete={handleToggleComplete} onLocate={handleLocate} userLocation={userLocation} onSelectActivity={handleSelectActivity} /></div>}
                        {activeTab === 'map' && <MapComponent activities={itinerary} userLocation={userLocation} focusedLocation={mapFocus} />}
                        {activeTab === 'budget' && <Budget itinerary={itinerary} />}
                        {activeTab === 'guide' && <Guide userLocation={userLocation} />}
                    </main>

                    {selectedActivityConfig && (
                        <ActivityDetailModal 
                            activity={selectedActivityConfig.activity} 
                            initialAutoOpen={selectedActivityConfig.autoOpenAudio}
                            onClose={() => setSelectedActivityConfig(null)} 
                        />
                    )}

                    <nav className="bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-30 pb-safe shrink-0">
                        <div className="flex justify-around items-center h-16">
                            {[
                                { id: 'timeline', icon: CalendarClock, label: 'Itinerario' },
                                { id: 'map', icon: MapIcon, label: 'Mapa' },
                                { id: 'budget', icon: Wallet, label: 'Gastos' },
                                { id: 'guide', icon: BookOpen, label: 'Guía' }
                            ].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center w-full h-full justify-center transition-colors ${activeTab === tab.id ? 'text-fjord-600' : 'text-slate-300'}`}>
                                    <tab.icon size={24} strokeWidth={activeTab === tab.id ? 2.5 : 2} />
                                    <span className="text-[10px] mt-1 font-bold">{tab.label}</span>
                                </button>
                            ))}
                        </div>
                    </nav>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>